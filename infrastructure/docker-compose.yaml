# RAG Pepper - Personal RAG System for Solo Developers
# Docker Compose for Dify + n8n Integration
#
# Architecture: Obsidian -> n8n -> Supabase (Cloud) -> Dify -> MCP -> Claude Desktop
#
# Usage:
#   1. Copy .env.example to .env and configure
#   2. docker compose up -d
#   3. Access Dify at http://localhost (port 80)
#   4. Access n8n at http://localhost:5678

services:
  # ============================================
  # Dify Core Services
  # ============================================

  # Dify API Server
  api:
    image: langgenius/dify-api:latest
    restart: always
    environment:
      # Startup mode
      MODE: api
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      LOG_FILE: ${LOG_FILE:-}
      DEBUG: ${DEBUG:-false}
      FLASK_DEBUG: ${FLASK_DEBUG:-false}
      SECRET_KEY: ${SECRET_KEY:?error}
      INIT_PASSWORD: ${INIT_PASSWORD:-}
      DEPLOY_ENV: ${DEPLOY_ENV:-PRODUCTION}

      # Database
      DB_USERNAME: ${DB_USERNAME:-postgres}
      DB_PASSWORD: ${DB_PASSWORD:-difyai123456}
      DB_HOST: ${DB_HOST:-db}
      DB_PORT: ${DB_PORT:-5432}
      DB_DATABASE: ${DB_DATABASE:-dify}
      SQLALCHEMY_POOL_SIZE: ${SQLALCHEMY_POOL_SIZE:-30}
      SQLALCHEMY_POOL_RECYCLE: ${SQLALCHEMY_POOL_RECYCLE:-3600}

      # Redis
      REDIS_HOST: ${REDIS_HOST:-redis}
      REDIS_PORT: ${REDIS_PORT:-6379}
      REDIS_USERNAME: ${REDIS_USERNAME:-}
      REDIS_PASSWORD: ${REDIS_PASSWORD:-difyai123456}
      REDIS_DB: ${REDIS_DB:-0}

      # Celery
      CELERY_BROKER_URL: ${CELERY_BROKER_URL:-redis://:difyai123456@redis:6379/1}

      # Storage
      STORAGE_TYPE: ${STORAGE_TYPE:-local}
      STORAGE_LOCAL_PATH: /app/api/storage

      # Vector Store (Using Supabase pgvector externally)
      VECTOR_STORE: ${VECTOR_STORE:-}

      # External DB (Supabase pgvector)
      SUPABASE_URL: ${SUPABASE_URL:-}
      SUPABASE_API_KEY: ${SUPABASE_API_KEY:-}

      # OpenAI
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}

      # Console/API URLs
      CONSOLE_WEB_URL: ${CONSOLE_WEB_URL:-}
      CONSOLE_API_URL: ${CONSOLE_API_URL:-}
      SERVICE_API_URL: ${SERVICE_API_URL:-}
      APP_WEB_URL: ${APP_WEB_URL:-}
      APP_API_URL: ${APP_API_URL:-}
      FILES_URL: ${FILES_URL:-}

      # Migration
      MIGRATION_ENABLED: ${MIGRATION_ENABLED:-true}

    depends_on:
      - db
      - redis
    volumes:
      - dify_storage:/app/api/storage
    networks:
      - rag-pepper-network

  # Dify Worker (Celery)
  worker:
    image: langgenius/dify-api:latest
    restart: always
    environment:
      MODE: worker
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      SECRET_KEY: ${SECRET_KEY:?error}

      # Database
      DB_USERNAME: ${DB_USERNAME:-postgres}
      DB_PASSWORD: ${DB_PASSWORD:-difyai123456}
      DB_HOST: ${DB_HOST:-db}
      DB_PORT: ${DB_PORT:-5432}
      DB_DATABASE: ${DB_DATABASE:-dify}

      # Redis
      REDIS_HOST: ${REDIS_HOST:-redis}
      REDIS_PORT: ${REDIS_PORT:-6379}
      REDIS_PASSWORD: ${REDIS_PASSWORD:-difyai123456}
      REDIS_DB: ${REDIS_DB:-0}

      # Celery
      CELERY_BROKER_URL: ${CELERY_BROKER_URL:-redis://:difyai123456@redis:6379/1}

      # Storage
      STORAGE_TYPE: ${STORAGE_TYPE:-local}
      STORAGE_LOCAL_PATH: /app/api/storage

      # OpenAI
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}

    depends_on:
      - db
      - redis
    volumes:
      - dify_storage:/app/api/storage
    networks:
      - rag-pepper-network

  # Dify Web Frontend
  web:
    image: langgenius/dify-web:latest
    restart: always
    environment:
      CONSOLE_API_URL: ${CONSOLE_API_URL:-}
      APP_API_URL: ${APP_API_URL:-}
      SENTRY_DSN: ${WEB_SENTRY_DSN:-}
      NEXT_TELEMETRY_DISABLED: ${NEXT_TELEMETRY_DISABLED:-1}
    networks:
      - rag-pepper-network

  # ============================================
  # Dify Dependencies
  # ============================================

  # PostgreSQL Database
  db:
    image: postgres:15-alpine
    restart: always
    environment:
      PGUSER: ${DB_USERNAME:-postgres}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-difyai123456}
      POSTGRES_DB: ${DB_DATABASE:-dify}
      PGDATA: /var/lib/postgresql/data/pgdata
    command: >
      postgres -c 'max_connections=100'
               -c 'shared_buffers=128MB'
               -c 'work_mem=4MB'
               -c 'maintenance_work_mem=64MB'
               -c 'effective_cache_size=256MB'
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "${DB_USERNAME:-postgres}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - rag-pepper-network

  # Redis
  redis:
    image: redis:6-alpine
    restart: always
    command: redis-server --requirepass ${REDIS_PASSWORD:-difyai123456}
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-difyai123456}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - rag-pepper-network

  # Nginx Reverse Proxy
  nginx:
    image: nginx:latest
    restart: always
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
    depends_on:
      - api
      - web
    ports:
      - "${NGINX_PORT:-80}:80"
    networks:
      - rag-pepper-network

  # ============================================
  # n8n Automation
  # ============================================

  n8n:
    image: docker.n8n.io/n8nio/n8n:latest
    restart: always
    environment:
      # Timezone
      GENERIC_TIMEZONE: ${GENERIC_TIMEZONE:-Asia/Seoul}
      TZ: ${GENERIC_TIMEZONE:-Asia/Seoul}

      # n8n Configuration
      N8N_HOST: ${N8N_HOST:-localhost}
      N8N_PORT: 5678
      N8N_PROTOCOL: ${N8N_PROTOCOL:-http}
      N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS: true
      N8N_RUNNERS_ENABLED: true

      # Webhook URL (for external triggers)
      WEBHOOK_URL: ${N8N_WEBHOOK_URL:-http://localhost:5678/}

      # Database (optional, defaults to SQLite)
      # DB_TYPE: postgresdb
      # DB_POSTGRESDB_HOST: db
      # DB_POSTGRESDB_PORT: 5432
      # DB_POSTGRESDB_DATABASE: n8n
      # DB_POSTGRESDB_USER: postgres
      # DB_POSTGRESDB_PASSWORD: difyai123456

      # Execution mode
      EXECUTIONS_MODE: ${N8N_EXECUTIONS_MODE:-regular}

      # MCP Access (optional)
      # N8N_DISABLED_MODULES: ${N8N_DISABLED_MODULES:-}

    ports:
      - "${N8N_PORT:-5678}:5678"
    volumes:
      - n8n_data:/home/node/.n8n
      # Mount Obsidian vault for file watching
      - ${OBSIDIAN_VAULT_PATH:-./obsidian-vault}:/obsidian-vault:ro
      # Local files for n8n workflows
      - ./n8n-local-files:/files
    networks:
      - rag-pepper-network

# ============================================
# Volumes
# ============================================
volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  dify_storage:
    driver: local
  n8n_data:
    driver: local

# ============================================
# Networks
# ============================================
networks:
  rag-pepper-network:
    driver: bridge
